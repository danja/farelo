<!DOCTYPE html>
<html lang="en">
    
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Form</title>
        <link rel="stylesheet" href="styles.css">
        <script>
            import rdf from 'rdf-ext';
            import N3Writer from '@rdfjs/parser-n3';


            function createRDFNodes(data, parentSubject = null) {
                const dataset = rdf.dataset();
                const subject = parentSubject || rdf.blankNode();

                data.forEach(item = > {
                    const predicate = rdf.namedNode(item.namespace + item.term);

                    if (item.entries) {
                        // Handle multiple nested entries
                        item.entries.forEach(entry = > {
                            const entrySubject = rdf.blankNode();
                            dataset.add(rdf.quad(subject, predicate, entrySubject));
                            const nestedDataset = createRDFNodes(Object.values(entry), entrySubject);
                            dataset.addAll(nestedDataset);
                        });
                    } else {
                        let object;
                        if (item.type === 'LITERAL') {
                            object = rdf.literal(item.value);
                        } else if (item.type === 'URI') {
                            object = rdf.namedNode(item.value);
                        } else {
                            object = rdf.blankNode();
                        }
                        dataset.add(rdf.quad(subject, predicate, object));
                    }
                });

                return dataset;
            }

            function extractAllElementsData(form) {
                const elements = form.querySelectorAll('input, textarea');
                const data = Array.from(elements).map(extractElementData);

                // Group nested properties
                const groupedData = data.reduce((acc, item) = > {
                    if (item.children) {
                        const parentIndex = acc.findIndex(d = > d.term === item.term);
                        if (parentIndex !== -1) {
                            acc[parentIndex].children = item.children;
                        } else {
                            acc.push(item);
                        }
                    } else {
                        acc.push(item);
                    }
                    return acc;
                }, []);

                return groupedData;
            }

            /*
function extractElementData(element) {
    const data = {};
    for (const attr of element.attributes) {
        if (attr.name.startsWith('data-')) {
            const key = attr.name.slice(5); // Remove 'data-' prefix
            data[key] = attr.value;
        }
    }
    data.value = element.value;
    return data;
}
    */

            function extractElementData(element) {
                const data = {};
                for (const attr of element.attributes) {
                    if (attr.name.startsWith('data-')) {
                        const key = attr.name.slice(5); // Remove 'data-' prefix
                        try {
                            // Try to parse as JSON for nested structures
                            data[key] = JSON.parse(attr.value);
                        } catch {
                            // If not JSON, store as is
                            data[key] = attr.value;
                        }
                    }
                }
                data.value = element.value;
                if (element.tagName === 'FIELDSET') {
                    data.entries = Array.from(element.querySelectorAll('.nested-entry'))
                        .map(entry = > {
                        const entryData = {};
                        entry.querySelectorAll('input, textarea').forEach(input = > {
                            const inputData = extractElementData(input);
                            entryData[inputData.term] = inputData;
                        });
                        return entryData;
                    });
                }
                return data;
            }


            function datasetToTurtle(dataset) {
                const writer = new N3Writer();
                let turtleString = '';

                writer.import(dataset.toStream())
                    .on('data', (chunk) = > {
                    turtleString += chunk;
                })
                    .on('end', () = > {
                    console.log('Serialization complete');
                });

                return turtleString;
            }

            // Main extract function
            function extract(document) {
                const form = document.querySelector('form');
                const data = extractAllElementsData(form);
                const dataset = createRDFNodes(data);
                return datasetToTurtle(dataset);
            }

            // Make sure to export the extract function
            export {
                extract
            };
        </script>
    </head>
    
    <body>
        <header>
             <h1>Form</h1>

        </header>
        <main>
            <!-- Your form content will go here -->
        </main>
        <footer>
            <p>Â© 2023 Your Name/Organization</p>
        </footer>
        <form>
            <div class="form-group">
                <label>name</label>
            </div>
            <textarea data-term="name" data-type="LITERAL" data-namespace="http://xmlns.com/foaf/0.1/"></textarea>
            <div class="form-group">
                <label>mbox</label>
            </div>
            <textarea data-term="mbox" data-type="URI" data-namespace="http://xmlns.com/foaf/0.1/"></textarea>
            <div class="form-group">
                <label>homepage</label>
            </div>
            <textarea data-term="homepage" data-type="URI" data-namespace="http://xmlns.com/foaf/0.1/"></textarea>
            <div class="form-group">
                <label>nick</label>
            </div>
            <textarea data-term="nick" data-type="LITERAL" data-namespace="http://xmlns.com/foaf/0.1/"></textarea>
            <div class="form-group">
                <label>depiction</label>
            </div>
            <textarea data-term="depiction" data-type="URI" data-namespace="http://xmlns.com/foaf/0.1/"></textarea>
            <div class="form-group">
                <label>interest</label>
            </div>
            <textarea data-term="interest" data-type="URI" data-namespace="http://xmlns.com/foaf/0.1/"></textarea>
            <div class="form-group">
                <label>knows</label>
            </div>
            <fieldset data-term="knows" data-type="BNODE" data-namespace="http://xmlns.com/foaf/0.1/" data-children="{&quot;properties&quot;:[{&quot;term&quot;:&quot;name&quot;,&quot;type&quot;:&quot;LITERAL&quot;,&quot;namespace&quot;:&quot;http://xmlns.com/foaf/0.1/&quot;}],&quot;namespace&quot;:&quot;http://xmlns.com/foaf/0.1/&quot;,&quot;type&quot;:&quot;Person&quot;}">
                <legend>knows</legend>
                <div class="nested-entry">
                    <div class="form-group">
                        <label>name</label>
                        <textarea data-term="name" data-type="LITERAL" data-namespace="http://xmlns.com/foaf/0.1/"></textarea>
                    </div>
                    <button type="button">Remove</button>
                </div>
                <button type="button">Add knows</button>
            </fieldset>
            <fieldset>
                <legend>knows</legend>
                <div class="form-group">
                    <label>name</label>
                </div>
                <textarea data-term="name" data-type="LITERAL" data-namespace="http://xmlns.com/foaf/0.1/"></textarea>
            </fieldset>
            <div class="form-group">
                <label>maintainer-of</label>
            </div>
            <fieldset data-term="maintainer-of" data-type="BNODE" data-namespace="http://usefulinc.com/ns/doap#" data-children="{&quot;properties&quot;:[{&quot;term&quot;:&quot;homepage&quot;,&quot;type&quot;:&quot;URI&quot;,&quot;namespace&quot;:&quot;http://usefulinc.com/ns/doap#&quot;},{&quot;term&quot;:&quot;description&quot;,&quot;type&quot;:&quot;LITERAL&quot;,&quot;namespace&quot;:&quot;http://usefulinc.com/ns/doap#&quot;,&quot;subtype&quot;:&quot;LANG&quot;}],&quot;namespace&quot;:&quot;http://usefulinc.com/ns/doap#&quot;,&quot;type&quot;:&quot;Project&quot;}">
                <legend>maintainer-of</legend>
                <div class="nested-entry">
                    <div class="form-group">
                        <label>homepage</label>
                        <textarea data-term="homepage" data-type="URI" data-namespace="http://usefulinc.com/ns/doap#"></textarea>
                    </div>
                    <div class="form-group">
                        <label>description</label>
                        <textarea data-term="description" data-type="LITERAL" data-namespace="http://usefulinc.com/ns/doap#" data-subtype="LANG"></textarea>
                    </div>
                    <button type="button">Remove</button>
                </div>
                <button type="button">Add maintainer-of</button>
            </fieldset>
            <fieldset>
                <legend>maintainer-of</legend>
                <div class="form-group">
                    <label>homepage</label>
                </div>
                <textarea data-term="homepage" data-type="URI" data-namespace="http://usefulinc.com/ns/doap#"></textarea>
                <div class="form-group">
                    <label>description</label>
                </div>
                <textarea data-term="description" data-type="LITERAL" data-namespace="http://usefulinc.com/ns/doap#" data-subtype="LANG"></textarea>
            </fieldset>
            <div class="form-group">
                <label>taskStatus</label>
            </div>
            <input type="checkbox" data-term="taskStatus" data-type="LITERAL" data-namespace="http://purl.org/stuff/prj/" data-subtype="BOOLEAN">
            <div class="form-group">
                <label>priority</label>
            </div>
            <input type="number" data-term="priority" data-type="LITERAL" data-namespace="http://purl.org/stuff/prj/" data-subtype="INTEGER">
            <button type="button">Submit</button>
            <label for="output">Output</label>
            <textarea id="output" rows="10"></textarea>
        </form>
    </body>

</html>